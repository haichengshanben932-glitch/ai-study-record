<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIè¨˜éŒ² - å®Œå…¨ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body { font-family: sans-serif; background: #e0f2ff; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 0; }
    .nav { width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn-nav { color: #3b82f6; text-decoration: none; font-size: 14px; font-weight: bold; }
    .container { width: 95%; max-width: 450px; padding: 15px; box-sizing: border-box; }
    #videoElement { width: 100%; aspect-ratio: 3 / 4; object-fit: cover; border-radius: 10px; background: #000; }
    #captureButton { background: #e81a4b; color: white; padding: 20px; border: none; border-radius: 50%; width: 70px; height: 70px; font-size: 1.5rem; display: block; margin: -35px auto 10px auto; position: relative; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    #status { text-align:center; font-size:0.9rem; margin: 10px 0; color: #1a73e8; font-weight: bold; background: white; padding: 5px; border-radius: 5px; }
    /* ã‚¹ãƒãƒ›ç”¨ãƒ­ã‚°å‡ºåŠ›ã‚¨ãƒªã‚¢ */
    #debugLog { width: 100%; font-size: 10px; color: #333; background: #eee; padding: 5px; border-radius: 5px; max-height: 80px; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; }
    #detectedNumbersList { background: #fff; border-radius: 8px; padding: 10px; min-height: 40px; margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; border: 1px solid #ddd; }
    .tag { background: #e0f2ff; padding: 5px 10px; border-radius: 6px; font-size: 0.9rem; font-weight: bold; color: #1e40af; border: 1px solid #bfdbfe; }
    .btn-save { background: #1a73e8; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 1.1rem; }
    input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
  </style>
</head>
<body>

  <nav class="nav">
    <a href="select_subject.html" class="btn-nav">ğŸ‘ˆ æˆ»ã‚‹</a>
    <a href="record.html" class="btn-nav">ğŸ“Š è¨˜éŒ²</a>
  </nav>

  <div class="container">
    <div id="status">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
    <video id="videoElement" autoplay playsinline></video>
    <button id="captureButton">ğŸ“·</button>
    
    <div id="debugLog">ãƒ­ã‚°ã‚’è¡¨ç¤ºä¸­...</div>

    <form id="studyForm">
      <div id="detectedNumbersList">ç•ªå·ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>
      <input type="number" id="studyTime" placeholder="å­¦ç¿’æ™‚é–“ (åˆ†)" required inputmode="numeric">
      <button type="submit" class="btn-save">ä¿å­˜</button>
    </form>
  </div>

<script>
  // è¨­å®š
  const ROBOTFLOW_API_KEY = "pfPc3Pu2ezLadUx7Dzw8"; 
  const statusDiv = document.getElementById('status');
  const logDiv = document.getElementById('debugLog');
  const video = document.getElementById('videoElement');
  let myModel;
  let detected = [];

  // ã‚¹ãƒãƒ›ç”»é¢ã«ãƒ­ã‚°ã‚’å‡ºã™é–¢æ•°
  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logDiv.textContent = `[${t}] ${msg}\n` + logDiv.textContent;
    console.log(msg);
  }

  // 1. ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿
  async function init() {
    try {
      log("TFJSãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...");
      // GitHub Pagesã®ãƒ‘ã‚¹å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ç›¸å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      myModel = await tf.loadLayersModel('./model.json');
      log("âœ… ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼");
      statusDiv.textContent = "READY (è‡ªä½œAI)";
      startCamera();
    } catch (e) {
      log("âŒ ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: " + e.message);
      statusDiv.textContent = "ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
      // ã‚«ãƒ¡ãƒ©ã ã‘ã§ã‚‚èµ·å‹•ã•ã›ã‚‹
      startCamera();
    }
  }

  // 2. ã‚«ãƒ¡ãƒ©èµ·å‹•
  function startCamera() {
    log("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...");
    navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
    }).then(s => {
      video.srcObject = s;
      log("âœ… ã‚«ãƒ¡ãƒ©æ¥ç¶šå®Œäº†");
    }).catch(e => {
      log("âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + e.message);
    });
  }

  // 3. ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
  document.getElementById('captureButton').onclick = async () => {
    if (!myModel) {
      alert("AIãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    
    statusDiv.textContent = "ğŸ” è§£æä¸­...";
    log("ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹...");
    
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth; 
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    try {
      // Roboflowã§æ æ¤œå‡º
      const base64 = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];
      log("Roboflow APIã¸é€ä¿¡ä¸­...");
      
      const roboflowRes = await fetch(`https://detect.roboflow.com/find-question-number/6?api_key=${ROBOTFLOW_API_KEY}`, { 
        method: "POST", body: base64, headers: { "Content-Type": "application/x-www-form-urlencoded" } 
      });
      const data = await roboflowRes.json();

      if (!data.predictions || data.predictions.length === 0) {
        statusDiv.textContent = "æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
        log("è­¦å‘Š: äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");
        return;
      }

      log(`${data.predictions.length}å€‹ã®æ ã‚’æ¤œå‡ºã€‚è‡ªä½œAIã§åˆ†é¡ä¸­...`);

      for (const p of data.predictions) {
        const padding = 15;
        const crop = document.createElement("canvas");
        crop.width = p.width + padding * 2;
        crop.height = p.height + padding * 2;
        const cropCtx = crop.getContext("2d");
        cropCtx.drawImage(canvas, p.x-p.width/2-padding, p.y-p.height/2-padding, p.width+padding*2, p.height+padding*2, 0, 0, crop.width, crop.height);

        // è‡ªä½œAIæ¨è«–
        const digit = await runInference(crop);
        if (digit !== null) {
          log(`åˆ¤å®šçµæœ: ${digit}`);
          if (!detected.includes(digit.toString())) {
            detected.push(digit.toString());
            renderTags();
          }
        }
      }
      statusDiv.textContent = "ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†";
    } catch(e) { 
      log("âŒ è§£æå¤±æ•—: " + e.message);
      statusDiv.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ"; 
    }
  };

  async function runInference(sourceCanvas) {
    try {
      const tensor = tf.tidy(() => {
        return tf.browser.fromPixels(sourceCanvas, 1)
          .resizeNearestNeighbor([28, 28])
          .toFloat()
          .div(tf.scalar(255.0))
          .expandDims();
      });

      const prediction = await myModel.predict(tensor);
      const scores = prediction.dataSync();
      const result = prediction.argMax(1).dataSync()[0];
      const confidence = Math.max(...scores);
      
      return confidence > 0.6 ? result : null;
    } catch (e) {
      log("æ¨è«–ã‚¨ãƒ©ãƒ¼: " + e.message);
      return null;
    }
  }

  function renderTags() {
    const list = document.getElementById('detectedNumbersList');
    list.innerHTML = detected.map(n => `<div class="tag">No.${n}</div>`).join('');
  }

  // åˆæœŸåŒ–å®Ÿè¡Œ
  init();

</script>
</body>
</html>