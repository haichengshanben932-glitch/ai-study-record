<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AIå‹‰å¼·è¨˜éŒ²ï¼ˆè¤‡æ•°OCRå¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #e0f2ff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .container { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
    h1 { text-align: center; color: #1a73e8; margin: 0 0 20px 0; }
    .upload { border: 2px dashed #4285f4; padding: 20px; text-align: center; border-radius: 10px; background: #f8fbff; margin-bottom: 20px; }
    input, button { width: 100%; padding: 12px; margin-top: 10px; font-size: 1rem; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
    #status { margin-top: 10px; color: #1a73e8; font-size: 0.85rem; min-height: 1.2em; text-align: center; }
    #history { width: 100%; max-width: 500px; }
    .history-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
    .delete-btn { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; width: auto; font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“˜ å‹‰å¼·ã‚’è¨˜éŒ²ã™ã‚‹</h1>
  <div class="upload">
    <p>ğŸ“· ãƒãƒ¼ãƒˆã®å†™çœŸã‹ã‚‰ç•ªå·ã‚’èª­ã¿å–ã‚‹</p>
    <input type="file" id="fileInput" accept="image/*">
    <div id="status">ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„</div>
  </div>

  <form id="studyForm">
    <label>ğŸ“… æ—¥ä»˜</label>
    <input type="date" id="date" required>
    <label>ğŸ”¢ å•é¡Œç•ªå·</label>
    <input type="text" id="problemNumber" placeholder="AIãŒèª­ã¿å–ã‚Šã¾ã™ï¼ˆè¤‡æ•°å¯ï¼‰" required>
    <button type="submit">è¨˜éŒ²ã‚’ä¿å­˜</button>
  </form>
</div>

<div id="history">
  <h3 style="color: #555; text-align: center;">ğŸ“ å­¦ç¿’ã®å±¥æ­´</h3>
  <div id="historyList"></div>
</div>

<script>
const API_KEY = "pfPc3Pu2ezLadUx7Dzw8";
const MODEL_ID = "find-question-number/5"; // Roboflowã®ãƒ¢ãƒ‡ãƒ«ID

document.getElementById("date").value = new Date().toISOString().split("T")[0];
loadHistory(); // å±¥æ­´ã®èª­ã¿è¾¼ã¿

document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const status = document.getElementById("status");
  status.textContent = "ğŸ”„ AIãŒå•é¡Œç•ªå·ã®å ´æ‰€ã‚’ç‰¹å®šä¸­...";

  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = async () => { // async ã‚’è¿½åŠ 
    // 1. ç”»åƒã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†
    const canvas = document.createElement("canvas");
    const MAX_WIDTH = 640;
    let width = img.width, height = img.height;
    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);
    const base64Data = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];

    // 2. Roboflowã§ã€Œæ•°å­—ã®å ´æ‰€ã€ã‚’å…¨ã¦è¦‹ã¤ã‘ã‚‹
    try {
      const response = await fetch(`https://detect.roboflow.com/${MODEL_ID}?api_key=${API_KEY}&confidence=30`, {
        method: "POST", body: base64Data, headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });
      const result = await response.json();

      if (result.predictions && result.predictions.length > 0) {
        status.textContent = `ğŸ”„ ${result.predictions.length}å€‹ã®ç•ªå·ã‚’è§£èª­ä¸­ï¼ˆOCRï¼‰...`;
        
        const detectedNumbers = [];
        // è¦‹ã¤ã‹ã£ãŸã™ã¹ã¦ã®äºˆæ¸¬ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
        for (const prediction of result.predictions) {
          if (prediction.class === "number") { // "number"ã¨ãƒ©ãƒ™ãƒ«ä»˜ã‘ã•ã‚ŒãŸã‚‚ã®ã ã‘ã‚’å‡¦ç†
            // 3. è¦‹ã¤ã‘ãŸæ ã®éƒ¨åˆ†ã ã‘ã‚’åˆ‡ã‚ŠæŠœã
            const cropCanvas = document.createElement("canvas");
            const cropCtx = cropCanvas.getContext("2d");
            cropCanvas.width = prediction.width;
            cropCanvas.height = prediction.height;
            cropCtx.drawImage(canvas, 
                              prediction.x - prediction.width/2, 
                              prediction.y - prediction.height/2, 
                              prediction.width, prediction.height, 
                              0, 0, 
                              prediction.width, prediction.height);
            
            // 4. Tesseract.jsã§æ–‡å­—èªè­˜
            const ocrResult = await Tesseract.recognize(cropCanvas, 'eng', {
              tessedit_char_whitelist: '0123456789' // æ•°å­—ã ã‘ã‚’èª­ã¿å–ã‚‹ã‚ˆã†ã«é™å®š
            });

            const parsedNum = ocrResult.data.text.replace(/[^0-9]/g, '');
            if (parsedNum) {
                detectedNumbers.push(parsedNum);
            }
          }
        }
        
        if (detectedNumbers.length > 0) {
          // èª­ã¿å–ã‚ŒãŸæ•°å­—ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
          document.getElementById("problemNumber").value = detectedNumbers.join(', ');
          status.textContent = `âœ… ${detectedNumbers.length}å€‹ã®ç•ªå·ã‚’è‡ªå‹•èª­ã¿å–ã‚ŠæˆåŠŸï¼`;
        } else {
          status.textContent = "âš ï¸ æ•°å­—ã‚’åˆ¤åˆ¥ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
          document.getElementById("problemNumber").focus();
        }
        
      } else {
        status.textContent = "âš ï¸ å•é¡Œç•ªå·ã®å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
      }
    } catch (err) {
      console.error("AIè§£æã‚¨ãƒ©ãƒ¼:", err);
      status.textContent = "âŒ è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    }
  };
});

// ä¿å­˜ãƒ»å‰Šé™¤ãƒ»å±¥æ­´è¡¨ç¤ºå‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰
document.getElementById("studyForm").addEventListener("submit", (e) => {
  e.preventDefault();
  const date = document.getElementById("date").value;
  const num = document.getElementById("problemNumber").value;
  
  if (!num) { // å•é¡Œç•ªå·ãŒç©ºã®å ´åˆã¯ä¿å­˜ã—ãªã„
    alert("å•é¡Œç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const record = { date, num, id: Date.now() };
  const history = JSON.parse(localStorage.getItem("studyRecords") || "[]");
  history.unshift(record); // æœ€æ–°ã®ã‚‚ã®ã‚’å…ˆé ­ã«è¿½åŠ 
  localStorage.setItem("studyRecords", JSON.stringify(history));
  document.getElementById("problemNumber").value = "";
  document.getElementById("status").textContent = "âœ… ä¿å­˜ã—ã¾ã—ãŸï¼";
  loadHistory();
});

function loadHistory() {
  const history = JSON.parse(localStorage.getItem("studyRecords") || "[]");
  const list = document.getElementById("historyList");
  list.innerHTML = history.map(r => `
    <div class="history-item">
      <span>ğŸ“… ${r.date} / <strong>No.${r.num}</strong></span>
      <button class="delete-btn" onclick="deleteRecord(${r.id})">å‰Šé™¤</button>
    </div>
  `).join("");
}

function deleteRecord(id) {
  let history = JSON.parse(localStorage.getItem("studyRecords") || "[]");
  history = history.filter(r => r.id !== id);
  localStorage.setItem("studyRecords", JSON.stringify(history));
  loadHistory();
}
</script>
</body>
</html>