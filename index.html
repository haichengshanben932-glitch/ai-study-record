<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹‰å¼·ã‚’è¨˜éŒ²ã™ã‚‹ - AI Study Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å†ç¾ */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            background-color: #e0f2ff; /* çˆ½ã‚„ã‹ãªæ°´è‰²ã®èƒŒæ™¯ */
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background-color: white;
            width: 100%;
            max-width: 500px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        h1 {
            text-align: center;
            color: #1a73e8;
            font-size: 1.6rem;
            margin-bottom: 25px;
        }

        /* AIã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .upload-section {
            border: 2px dashed #4285f4;
            background-color: #f8fbff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
        }

        .upload-label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #444;
            font-weight: bold;
        }

        .custom-file-input {
            background: white;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }

        #status {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #1a73e8;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #333;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d1d1;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #fff;
        }

        input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }

        button.submit-btn {
            width: 100%;
            padding: 15px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        button.submit-btn:hover {
            background-color: #1557b0;
        }

        #debugCanvas {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“˜ å‹‰å¼·ã‚’è¨˜éŒ²ã™ã‚‹</h1>

    <div class="upload-section">
        <span class="upload-label">ğŸ“· ãƒãƒ¼ãƒˆã®ç•ªå·ã‚’è‡ªå‹•å…¥åŠ›</span>
        <input type="file" id="fileInput" accept="image/*" class="custom-file-input">
        <div id="status">ç”»åƒã‚’é¸ã¶ã¨æ•°å­—ã‚’èª­ã¿å–ã‚Šã¾ã™</div>
        <canvas id="debugCanvas"></canvas>
    </div>

    <form id="studyForm">
        <div class="form-group">
            <label>ğŸ“… æ—¥ä»˜</label>
            <input type="date" id="date" required>
        </div>

        <div class="form-group">
            <label>ğŸ“š æ•™æã‚’é¸æŠ</label>
            <select id="material" required>
                <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="æ•°å­¦ã®å‹">æ•°å­¦ã®å‹</option>
                <option value="è‹±èªãƒ¯ãƒ¼ã‚¯">è‹±èªãƒ¯ãƒ¼ã‚¯</option>
                <option value="æ¼¢å­—ãƒ‰ãƒªãƒ«">æ¼¢å­—ãƒ‰ãƒªãƒ«</option>
            </select>
        </div>

        <div class="form-group">
            <label>ğŸ”¢ å•é¡Œç•ªå· / ãƒšãƒ¼ã‚¸</label>
            <input type="number" id="problemNumber" placeholder="AIã‚¹ã‚­ãƒ£ãƒ³ã¾ãŸã¯æ‰‹å…¥åŠ›" required>
        </div>

        <div class="form-group">
            <label>â±ï¸ å­¦ç¿’æ™‚é–“ (åˆ†)</label>
            <input type="number" id="minutes" placeholder="ä¾‹: 30" required>
        </div>

        <button type="submit" class="submit-btn">è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
    </form>
</div>

<script>
    // --- 1. åˆæœŸè¨­å®š ---
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const debugCanvas = document.getElementById('debugCanvas');
    const problemInput = document.getElementById('problemNumber');

    const WORKSPACE_ID = "new-workspace-o3oen";
    const WORKFLOW_ID = "custom-workflow-3";
    const API_KEY = "pfPc3Pu2ezLadUx7Dzw8";

    // --- 2. AIã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        status.textContent = "ğŸ”„ ç”»åƒã‚’æœ€é©åŒ–ä¸­...";
        
        try {
            // ç”»åƒã®ãƒªã‚µã‚¤ã‚º (413ã‚¨ãƒ©ãƒ¼å¯¾ç­–)
            const img = await createImageBitmap(file);
            const MAX_SIZE = 1000;
            let width = img.width;
            let height = img.height;
            const scale = Math.min(MAX_SIZE / width, MAX_SIZE / height, 1);
            
            const canvas = document.createElement('canvas');
            canvas.width = width * scale;
            canvas.height = height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // Base64å¤‰æ›
            const base64Data = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            status.textContent = "ğŸ¤– AIè§£æä¸­...";
            
            // å®‰å®šæ€§ã®é«˜ã„URLå½¢å¼
            const url = `https://app.roboflow.com/workflows/${WORKSPACE_ID}/${WORKFLOW_ID}/outputs?api_key=${API_KEY}`;

            const response = await fetch(url, {
                method: "POST",
                body: base64Data,
                headers: { "Content-Type": "text/plain" }
            });

            if (!response.ok) throw new Error("APIæ¥ç¶šã‚¨ãƒ©ãƒ¼");

            const result = await response.json();
            const predictions = result.outputs?.[0]?.predictions || [];

            if (predictions.length > 0) {
                status.textContent = "ğŸ” æ•°å­—ã‚’æŠ½å‡ºä¸­...";
                const p = predictions[0];
                
                // åˆ‡ã‚ŠæŠœãè¡¨ç¤º
                debugCanvas.width = p.width;
                debugCanvas.height = p.height;
                const dCtx = debugCanvas.getContext('2d');
                dCtx.drawImage(canvas, p.x - p.width/2, p.y - p.height/2, p.width, p.height, 0, 0, p.width, p.height);
                debugCanvas.style.display = "block";

                // OCRå®Ÿè¡Œ
                const { data: { text } } = await Tesseract.recognize(debugCanvas, 'eng');
                const cleanNum = text.replace(/[^0-9]/g, '');
                
                if(cleanNum) {
                    problemInput.value = cleanNum;
                    status.textContent = "âœ… èª­ã¿å–ã‚ŠæˆåŠŸï¼";
                } else {
                    status.textContent = "âš ï¸ æ•°å­—ãŒåˆ¤åˆ¥ã§ãã¾ã›ã‚“ã§ã—ãŸ";
                }
            } else {
                status.textContent = "â“ æ•°å­—ã®æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
            }
        } catch (err) {
            status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            console.error(err);
        }
    });

    // --- 3. ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ ---
    document.getElementById('studyForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const newRecord = {
            date: document.getElementById('date').value,
            material: document.getElementById('material').value,
            pages: parseInt(document.getElementById('problemNumber').value),
            minutes: parseInt(document.getElementById('minutes').value)
        };
        const records = JSON.parse(localStorage.getItem("records")) || [];
        records.push(newRecord);
        localStorage.setItem("records", JSON.stringify(records));
        
        alert("å­¦ç¿’å†…å®¹ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
        window.location.href = "index.html";
    });
</script>

</body>
</html>