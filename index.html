<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è¨˜éŒ²å…¥åŠ› - AIå‹‰å¼·ç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #e0f2ff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .nav { margin-bottom: 20px; display: flex; gap: 10px; }
    .btn-nav { background: #3b82f6; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: bold; }
    .btn-nav.active { background: #1e40af; }
    .container { background: white; width: 100%; max-width: 450px; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #1a73e8; margin-top: 0; font-size: 1.4rem; }
    .upload { border: 2px dashed #4285f4; padding: 15px; text-align: center; border-radius: 10px; background: #f8fbff; margin-bottom: 15px; }
    label { display: block; margin-top: 12px; font-weight: bold; color: #555; font-size: 0.85rem; }
    input, select, button { width: 100%; padding: 12px; margin-top: 5px; font-size: 1rem; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; }
    .btn-save { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
    #status { margin-top: 10px; color: #1a73e8; font-size: 0.8rem; text-align: center; min-height: 1.2em; }
    .history-item { background: white; padding: 12px; border-radius: 8px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%; max-width: 450px; }
    .delete-btn { background: #ff4d4d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; width: auto; font-size: 0.7rem; }
  </style>
</head>
<body>

  <div class="nav">
    <a href="index.html" class="btn-nav active">ğŸ“ è¨˜éŒ²å…¥åŠ›</a>
    <a href="ranking.html" class="btn-nav">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
    <a href="record.html" class="btn-nav">ğŸ“Š å¯è¦–åŒ–</a>
  </div>

  <div class="container">
    <h1>ğŸ“˜ ä»Šæ—¥ã®å‹‰å¼·ã‚’è¨˜éŒ²</h1>
    <div class="upload">
      <input type="file" id="fileInput" accept="image/*">
      <div id="status">ç”»åƒã‹ã‚‰ç•ªå·ã‚’è‡ªå‹•å…¥åŠ›</div>
    </div>
    <form id="studyForm">
      <label>ğŸ“… æ—¥ä»˜</label><input type="date" id="date" required>
      <label>ğŸ“š æ•™æå</label>
      <select id="subject" required>
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="æ•°å­¦">æ•°å­¦</option><option value="è‹±èª">è‹±èª</option>
        <option value="ç†ç§‘">ç†ç§‘</option><option value="ç¤¾ä¼š">ç¤¾ä¼š</option><option value="å›½èª">å›½èª</option>
      </select>
      <label>ğŸ”¢ å•é¡Œç•ªå·</label><input type="text" id="problemNumber" required>
      <label>â± æ™‚é–“ (åˆ†)</label><input type="number" id="studyTime" required>
      <button type="submit" class="btn-save">ä¿å­˜ã™ã‚‹</button>
    </form>
  </div>

  <div id="historyList" style="width:100%; max-width:450px; margin-top:10px;"></div>

<script>
  // å®‰å®šã—ã¦å‹•ä½œã™ã‚‹ Object Detection API ã®è¨­å®š
  const API_KEY = "pfPc3Pu2ezLadUx7Dzw8";
  const MODEL_ID = "find-question-number/5"; 

  document.getElementById("date").value = new Date().toISOString().split("T")[0];
  loadHistory();

  document.getElementById("fileInput").addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const status = document.getElementById('status');
    const problemInput = document.getElementById('problemNumber');
    status.textContent = "AIè§£æä¸­...";
    problemInput.value = "";

    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = async () => {
      // 1. ç”»åƒã®ãƒªã‚µã‚¤ã‚ºï¼ˆContent Too Large å¯¾ç­–ï¼‰
      const canvas = document.createElement("canvas");
      const MAX_WIDTH = 640;
      let width = img.width, height = img.height;
      if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
      const base64Data = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];

      try {
        // 2. Roboflow API ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const response = await fetch(`https://detect.roboflow.com/${MODEL_ID}?api_key=${API_KEY}`, {
          method: "POST",
          body: base64Data,
          headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
        const result = await response.json();

        if (result.predictions && result.predictions.length > 0) {
          status.textContent = `${result.predictions.length}å€‹ã‚’èª­è§£ä¸­...`;
          const detectedNumbers = [];

          for (const p of result.predictions) {
            // 3. å„ç•ªå·ã‚’åˆ‡ã‚ŠæŠœã„ã¦ OCR
            const cropCanvas = document.createElement("canvas");
            cropCanvas.width = p.width;
            cropCanvas.height = p.height;
            cropCanvas.getContext("2d").drawImage(canvas, p.x - p.width/2, p.y - p.height/2, p.width, p.height, 0, 0, p.width, p.height);
            
            const ocr = await Tesseract.recognize(cropCanvas, 'eng', { tessedit_char_whitelist: '0123456789' });
            const num = ocr.data.text.replace(/[^0-9]/g, '');
            if (num) detectedNumbers.push(num);
          }
          
          problemInput.value = detectedNumbers.join(', ');
          status.textContent = detectedNumbers.length > 0 ? "âœ… èª­ã¿å–ã‚ŠæˆåŠŸï¼" : "âš ï¸ æ•°å­—ãŒèª­ã‚ã¾ã›ã‚“ã§ã—ãŸ";
        } else {
          status.textContent = "âš ï¸ ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
        }
      } catch (err) {
        console.error(err);
        status.textContent = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆAPIã‚­ãƒ¼ã‚„ãƒ¢ãƒ‡ãƒ«IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
      }
    };
  });

  document.getElementById("studyForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const record = {
      date: document.getElementById("date").value,
      subject: document.getElementById("subject").value,
      num: document.getElementById("problemNumber").value,
      time: document.getElementById("studyTime").value,
      id: Date.now()
    };
    const history = JSON.parse(localStorage.getItem("studyRecords") || "[]");
    history.unshift(record);
    localStorage.setItem("studyRecords", JSON.stringify(history));
    document.getElementById("problemNumber").value = "";
    document.getElementById("studyTime").value = "";
    document.getElementById("status").textContent = "ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„";
    loadHistory();
  });

  function loadHistory() {
    const history = JSON.parse(localStorage.getItem("studyRecords") || "[]");
    document.getElementById("historyList").innerHTML = history.map(r => `
      <div class="history-item">
        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#888;">
          <span>ğŸ“… ${r.date}</span><span>â± ${r.time}åˆ†</span>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
          <span><strong>ã€${r.subject}ã€‘</strong> No.${r.num}</span>
          <button class="delete-btn" onclick="deleteRecord(${r.id})">å‰Šé™¤</button>
        </div>
      </div>
    `).join("");
  }
  function deleteRecord(id) { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { let h = JSON.parse(localStorage.getItem("studyRecords") || "[]"); h = h.filter(r => r.id !== id); localStorage.setItem("studyRecords", JSON.stringify(h)); loadHistory(); } }
</script>
</body>
</html>