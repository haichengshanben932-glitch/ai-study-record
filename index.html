<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Tracker - è¨˜éŒ²</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      background: linear-gradient(180deg, #C2EEFF 0%, #EAF9FF 100%);
      margin: 0; padding: 20px; color: #333; min-height: 100vh;
    }
    .container { max-width: 500px; margin: auto; background: #ffffffcc; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
    h1 { text-align: center; color: #2563eb; font-size: 26px; margin-bottom: 25px; }
    
    /* AIã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒªã‚¢ */
    .camera-section {
      border: 2px dashed #3b82f6; background: #eff6ff; padding: 15px;
      text-align: center; border-radius: 15px; margin-bottom: 25px;
    }
    #status { color: #2563eb; font-weight: bold; margin: 8px 0; font-size: 13px; }
    #debugCanvas { border: 2px solid #60a5fa; max-width: 100%; border-radius: 10px; display: none; margin-top: 10px; }
    
    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 6px; font-weight: bold; color: #1e3a8a; font-size: 14px; }
    input, select { 
      width: 100%; padding: 12px; border: 1px solid #bfdbfe; border-radius: 10px; 
      box-sizing: border-box; font-size: 16px; background: white;
    }
    input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 5px rgba(59,130,246,0.2); }
    
    .btn-save { 
      width: 100%; padding: 15px; background: #3b82f6; color: white; border: none; 
      border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; 
      transition: 0.3s; margin-top: 10px; box-shadow: 0 4px 12px rgba(59,130,246,0.3); 
    }
    .btn-save:hover { background: #2563eb; transform: translateY(-2px); }
    .btn-back { display: block; text-align: center; margin-top: 20px; color: #64748b; text-decoration: none; font-size: 14px; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“˜ å‹‰å¼·ã‚’è¨˜éŒ²ã™ã‚‹</h1>

  <div class="camera-section">
    <label>ğŸ“· ãƒãƒ¼ãƒˆã®ç•ªå·ã‚’è‡ªå‹•å…¥åŠ›</label>
    <input type="file" id="fileInput" accept="image/*" style="margin-top:10px;">
    <div id="status">ç”»åƒã‚’é¸ã¶ã¨æ•°å­—ã‚’èª­ã¿å–ã‚Šã¾ã™</div>
    <canvas id="debugCanvas"></canvas>
  </div>

  <hr style="border: 0; border-top: 1px solid #bfdbfe; margin-bottom: 20px;">

  <form id="studyForm">
    <div class="form-group">
      <label>ğŸ“… æ—¥ä»˜</label>
      <input type="date" id="date" required>
    </div>

    <div class="form-group">
      <label>ğŸ“š æ•™æã‚’é¸æŠ</label>
      <select id="material" required>
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="æ•°å­¦ãƒ¯ãƒ¼ã‚¯">æ•°å­¦ãƒ¯ãƒ¼ã‚¯</option>
        <option value="è‹±èªãƒ†ã‚­ã‚¹ãƒˆ">è‹±èªãƒ†ã‚­ã‚¹ãƒˆ</option>
        <option value="æ¼¢å­—ç·´ç¿’">æ¼¢å­—ç·´ç¿’</option>
        <option value="ç†ç§‘ãƒ—ãƒªãƒ³ãƒˆ">ç†ç§‘ãƒ—ãƒªãƒ³ãƒˆ</option>
        <option value="ãã®ä»–">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
      </select>
    </div>

    <div class="form-group">
      <label>ğŸ”¢ å•é¡Œç•ªå· / ãƒšãƒ¼ã‚¸</label>
      <input type="number" id="problemNumber" placeholder="AIã‚¹ã‚­ãƒ£ãƒ³ã¾ãŸã¯æ‰‹å…¥åŠ›" required>
    </div>

    <div class="form-group">
      <label>â±ï¸ å­¦ç¿’æ™‚é–“ (åˆ†)</label>
      <input type="number" id="minutes" placeholder="ä¾‹: 30" required>
    </div>

    <button type="submit" class="btn-save">ä¿å­˜ã™ã‚‹</button>
  </form>

  <a href="index.html" class="btn-back">â† æˆ»ã‚‹</a>
</div>

<script>
  // æ—¥ä»˜ã®åˆæœŸå€¤ã‚’ä»Šæ—¥ã«ã™ã‚‹
  document.getElementById('date').value = new Date().toISOString().split('T')[0];

  const fileInput = document.getElementById('fileInput');
  const status = document.getElementById('status');
  const debugCanvas = document.getElementById('debugCanvas');
  const problemInput = document.getElementById('problemNumber');

  // --- AIã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ (Roboflow) ---
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    status.textContent = "AIè§£æä¸­...";
    debugCanvas.style.display = "none";

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async () => {
      const base64Image = reader.result.split(',')[1];
      try {
        const workspace = "wHddFBv2H2OON7CZNk9ITBdMuhi2";
        const workflow = "vyBjY4jYF4pCqjPOF3Mv";
        const apiKey = "yRHyDV3o4x2Bymgsi3Ez";
        
        const response = await fetch(`https://api.roboflow.com/workflows/${workspace}/${workflow}/outputs?api_key=${apiKey}`, {
          method: "POST",
          body: JSON.stringify({ inputs: { "image": { "type": "base64", "value": base64Image } } })
        });
        const data = await response.json();
        let predictions = [];
        if (data.outputs && data.outputs[0]) {
          for (let key in data.outputs[0]) {
            if (data.outputs[0][key].predictions) { predictions = data.outputs[0][key].predictions; break; }
          }
        }
        if (predictions.length > 0) {
          status.textContent = "æ–‡å­—ã‚’èª­ã¿å–ã‚Šä¸­...";
          const p = predictions[0];
          const img = await createImageBitmap(file);
          const ctx = debugCanvas.getContext('2d');
          const cropX = p.x - (p.width / 2);
          const cropY = p.y - (p.height / 2);
          debugCanvas.width = p.width; debugCanvas.height = p.height;
          ctx.drawImage(img, cropX, cropY, p.width, p.height, 0, 0, p.width, p.height);
          debugCanvas.style.display = "block";
          const { data: { text } } = await Tesseract.recognize(debugCanvas, 'eng');
          const resultNum = text.replace(/[^0-9]/g, '');
          if (resultNum) { problemInput.value = resultNum; status.textContent = "èª­ã¿å–ã‚ŠæˆåŠŸï¼"; }
          else { status.textContent = "æ•°å­—ãŒèª­ã‚ã¾ã›ã‚“ã§ã—ãŸ"; }
        } else { status.textContent = "ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"; }
      } catch (err) { status.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
    };
  });

  // --- ä¿å­˜æ©Ÿèƒ½ (LocalStorage) ---
  document.getElementById('studyForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const newRecord = {
      date: document.getElementById('date').value,
      material: document.getElementById('material').value,
      pages: parseInt(document.getElementById('problemNumber').value),
      minutes: parseInt(document.getElementById('minutes').value),
      totalPages: 100 // é€²æ—è¨ˆç®—ç”¨ã®ä»®ã®å…¨ä½“æ•°
    };
    const records = JSON.parse(localStorage.getItem("records")) || [];
    records.push(newRecord);
    localStorage.setItem("records", JSON.stringify(records));
    alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼");
    window.location.href = "index.html";
  });
</script>
</body>
</html>