<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AIå‹‰å¼·è¨˜éŒ²ï¼ˆãƒ•ãƒ«æ©Ÿèƒ½ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #e0f2ff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .container { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
    h1 { text-align: center; color: #1a73e8; margin: 0 0 20px 0; font-size: 1.5rem; }
    .upload { border: 2px dashed #4285f4; padding: 15px; text-align: center; border-radius: 10px; background: #f8fbff; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; font-weight: bold; color: #555; font-size: 0.9rem; }
    input, select, button { width: 100%; padding: 12px; margin-top: 5px; font-size: 1rem; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.2s; }
    button:hover { background: #1557b0; }
    #status { margin-top: 10px; color: #1a73e8; font-size: 0.8rem; text-align: center; min-height: 1.2em; }
    
    /* å±¥æ­´ã‚¨ãƒªã‚¢ */
    #history { width: 100%; max-width: 500px; }
    .history-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .history-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .history-body { display: flex; justify-content: space-between; align-items: center; }
    .history-main { font-weight: bold; color: #333; }
    .delete-btn { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; width: auto; font-size: 0.75rem; margin: 0; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“˜ å‹‰å¼·ã‚’è¨˜éŒ²ã™ã‚‹</h1>
  
  <div class="upload">
    <p style="margin:0 0 10px 0; font-size:0.9rem;">ğŸ“· ãƒãƒ¼ãƒˆã®å†™çœŸã‹ã‚‰ç•ªå·ã‚’èª­ã¿å–ã‚‹</p>
    <input type="file" id="fileInput" accept="image/*">
    <div id="status">ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„</div>
  </div>

  <form id="studyForm">
    <label>ğŸ“… æ—¥ä»˜</label>
    <input type="date" id="date" required>

    <label>ğŸ“š æ•™æå</label>
    <select id="subject" required>
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="æ•°å­¦">æ•°å­¦</option>
      <option value="è‹±èª">è‹±èª</option>
      <option value="å›½èª">å›½èª</option>
      <option value="ç†ç§‘">ç†ç§‘</option>
      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>

    <label>ğŸ”¢ å•é¡Œç•ªå·</label>
    <input type="text" id="problemNumber" placeholder="AIãŒèª­ã¿å–ã‚Šã¾ã™ï¼ˆè¤‡æ•°å¯ï¼‰" required>

    <label>â± å­¦ç¿’æ™‚é–“ (åˆ†)</label>
    <input type="number" id="studyTime" placeholder="ä¾‹: 30" min="1" required>

    <button type="submit">ã“ã®å†…å®¹ã§ä¿å­˜ã™ã‚‹</button>
  </form>
</div>

<div id="history">
  <h3 style="color: #555; text-align: center;">ğŸ“ å­¦ç¿’ã®å±¥æ­´</h3>
  <div id="historyList"></div>
</div>

<script>
const API_KEY = "pfPc3Pu2ezLadUx7Dzw8";
const MODEL_ID = "find-question-number/5";

// åˆæœŸåŒ–
document.getElementById("date").value = new Date().toISOString().split("T")[0];
loadHistory();

// --- AIè§£æ (Roboflow + Tesseract.js) ---
document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const status = document.getElementById("status");
  status.textContent = "ğŸ”„ AIãŒå ´æ‰€ã‚’ç‰¹å®šä¸­...";

  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = async () => {
    const canvas = document.createElement("canvas");
    const MAX_WIDTH = 640;
    let width = img.width, height = img.height;
    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);
    const base64Data = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];

    try {
      const response = await fetch(`https://detect.roboflow.com/${MODEL_ID}?api_key=${API_KEY}&confidence=30`, {
        method: "POST", body: base64Data, headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });
      const result = await response.json();

      if (result.predictions && result.predictions.length > 0) {
        status.textContent = `ğŸ”„ ${result.predictions.length}å€‹ã‚’è§£èª­ä¸­...`;
        const detectedNumbers = [];

        for (const prediction of result.predictions) {
          const cropCanvas = document.createElement("canvas");
          const cropCtx = cropCanvas.getContext("2d");
          cropCanvas.width = prediction.width;
          cropCanvas.height = prediction.height;
          cropCtx.drawImage(canvas, prediction.x - prediction.width/2, prediction.y - prediction.height/2, prediction.width, prediction.height, 0, 0, prediction.width, prediction.height);
          
          const ocrResult = await Tesseract.recognize(cropCanvas, 'eng', { tessedit_char_whitelist: '0123456789' });
          const parsedNum = ocrResult.data.text.replace(/[^0-9]/g, '');
          if (parsedNum) detectedNumbers.push(parsedNum);
        }
        
        if (detectedNumbers.length > 0) {
          document.getElementById("problemNumber").value = detectedNumbers.join(', ');
          status.textContent = `âœ… ${detectedNumbers.length}å€‹ã®ç•ªå·ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸï¼`;
        } else {
          status.textContent = "âš ï¸ æ•°å­—ãŒåˆ¤åˆ¥ã§ãã¾ã›ã‚“ã§ã—ãŸ";
          document.getElementById("problemNumber").focus();
        }
      } else {
        status.textContent = "âš ï¸ ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
      }
    } catch (err) {
      status.textContent = "âŒ è§£æã‚¨ãƒ©ãƒ¼";
    }
  };
});

// --- ä¿å­˜ãƒ»è¡¨ç¤ºãƒ»å‰Šé™¤æ©Ÿèƒ½ ---
document.getElementById("studyForm").addEventListener("submit", (e) => {
  e.preventDefault();
  
  const record = {
    date: document.getElementById("date").value,
    subject: document.getElementById("subject").value,
    num: document.getElementById("problemNumber").value,
    time: document.getElementById("studyTime").value,
    id: Date.now()
  };

  const history = JSON.parse(localStorage.getItem("studyRecords") || "[]");
  history.unshift(record);
  localStorage.setItem("studyRecords", JSON.stringify(history));

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
  document.getElementById("problemNumber").value = "";
  document.getElementById("studyTime").value = "";
  document.getElementById("status").textContent = "âœ… ä¿å­˜ã—ã¾ã—ãŸï¼";
  loadHistory();
});

function loadHistory() {
  const history = JSON.parse(localStorage.getItem("studyRecords") || "[]");
  const list = document.getElementById("historyList");
  list.innerHTML = history.map(r => `
    <div class="history-item">
      <div class="history-header">
        <span>ğŸ“… ${r.date}</span>
        <span>â± ${r.time}åˆ†</span>
      </div>
      <div class="history-body">
        <div class="history-main">
          <span style="color:#1a73e8;">ã€${r.subject}ã€‘</span> No.${r.num}
        </div>
        <button class="delete-btn" onclick="deleteRecord(${r.id})">å‰Šé™¤</button>
      </div>
    </div>
  `).join("");
}

function deleteRecord(id) {
  if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  let history = JSON.parse(localStorage.getItem("studyRecords") || "[]");
  history = history.filter(r => r.id !== id);
  localStorage.setItem("studyRecords", JSON.stringify(history));
  loadHistory();
}
</script>
</body>
</html>