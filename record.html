<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ†æ - AIå‹‰å¼·ç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #f0f7ff; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    .nav { width: 100%; max-width: 500px; display: flex; justify-content: space-between; margin-bottom: 20px; }
    .btn-nav { color: #1a73e8; text-decoration: none; font-weight: bold; font-size: 14px; }
    .card { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; box-sizing: border-box; }
    h2 { font-size: 1.1rem; color: #1e40af; margin-top: 0; border-left: 4px solid #1a73e8; padding-left: 10px; }
    canvas { width: 100% !important; height: auto !important; }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .stat-item { background: #f8fbff; padding: 10px; border-radius: 8px; text-align: center; }
    .stat-val { font-size: 1.2rem; font-weight: bold; color: #1a73e8; }
    .stat-label { font-size: 0.7rem; color: #666; }
  </style>
</head>
<body>

  <nav class="nav">
    <a href="select_subject.html" class="btn-nav">ğŸ‘ˆ æ•™æé¸æŠ</a>
    <a href="index.html" class="btn-nav">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ã«æˆ»ã‚‹</a>
  </nav>

  <div class="card">
    <h2>ğŸ“Š å…¨ä½“ã®é€²æ—ç‡</h2>
    <canvas id="progressChart"></canvas>
    <div id="progressText" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
  </div>

  <div class="card">
    <h2>ğŸ“… æ—¥åˆ¥ã®å­¦ç¿’æ™‚é–“ (åˆ†)</h2>
    <canvas id="timeChart"></canvas>
  </div>

  <div class="card">
    <h2>âš¡ï¸ å­¦ç¿’åŠ¹ç‡ (1åˆ†ã‚ãŸã‚Šã®å•é¡Œæ•°)</h2>
    <canvas id="efficiencyChart"></canvas>
    <div style="font-size: 0.7rem; color: #888; margin-top: 5px;">â€»æ•°å€¤ãŒé«˜ã„ã»ã©é›†ä¸­ã—ã¦è§£ã‘ã¦ã„ã¾ã™</div>
  </div>

  <div class="card">
    <h2>ğŸ“ˆ ç·çµ±è¨ˆ</h2>
    <div class="stat-grid">
      <div class="stat-item"><div class="stat-val" id="totalTime">0</div><div class="stat-label">ç·å­¦ç¿’æ™‚é–“ (åˆ†)</div></div>
      <div class="stat-item"><div class="stat-val" id="totalQuestions">0</div><div class="stat-label">è§£ã„ãŸç·å•é¡Œæ•°</div></div>
    </div>
  </div>

<script>
  // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
  const records = JSON.parse(localStorage.getItem('studyRecords') || "[]");

  // 1. é€²æ—ç‡ã®é›†è¨ˆ (æœ€æ–°ã®æ•™æã‚’åŸºæº–ã«è¡¨ç¤º)
  function setupProgressChart() {
    if (records.length === 0) return;
    const latest = records[0];
    const subjectName = latest.subject;
    const totalGoal = latest.totalCount || 100;

    // ã“ã®æ•™æã§è§£ã„ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå•é¡Œç•ªå·ã®æ•°
    const solvedNums = new Set();
    records.filter(r => r.subject === subjectName).forEach(r => {
      r.num.split(',').forEach(n => { if(n) solvedNums.add(n) });
    });

    const solvedCount = solvedNums.size;
    const remaining = Math.max(0, totalGoal - solvedCount);
    const percent = Math.round((solvedCount / totalGoal) * 100);

    document.getElementById('progressText').textContent = `${subjectName}: ${percent}% å®Œäº†`;

    new Chart(document.getElementById('progressChart'), {
      type: 'doughnut',
      data: {
        labels: ['å®Œäº†', 'æœªå®Œäº†'],
        datasets: [{
          data: [solvedCount, remaining],
          backgroundColor: ['#1a73e8', '#e0f2ff'],
          borderWidth: 0
        }]
      },
      options: { cutout: '70%' }
    });
  }

  // 2. æ—¥åˆ¥å­¦ç¿’æ™‚é–“ & 3. åŠ¹ç‡ã®é›†è¨ˆ
  function setupHistoryCharts() {
    const dailyData = {};
    records.forEach(r => {
      const date = r.date;
      const time = parseInt(r.time) || 0;
      const count = r.num.split(',').filter(n => n !== "").length;

      if (!dailyData[date]) dailyData[date] = { time: 0, count: 0 };
      dailyData[date].time += time;
      dailyData[date].count += count;
    });

    const labels = Object.keys(dailyData).sort();
    const times = labels.map(l => dailyData[l].time);
    const efficiencies = labels.map(l => dailyData[l].time > 0 ? (dailyData[l].count / dailyData[l].time).toFixed(2) : 0);

    // æ£’ã‚°ãƒ©ãƒ• (æ™‚é–“)
    new Chart(document.getElementById('timeChart'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'å­¦ç¿’æ™‚é–“',
          data: times,
          backgroundColor: '#3b82f6',
          borderRadius: 5
        }]
      }
    });

    // æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• (åŠ¹ç‡)
    new Chart(document.getElementById('efficiencyChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'åŠ¹ç‡ (å•/åˆ†)',
          data: efficiencies,
          borderColor: '#10b981',
          backgroundColor: '#10b98133',
          fill: true,
          tension: 0.3
        }]
      }
    });

    // ç·è¨ˆ
    document.getElementById('totalTime').textContent = times.reduce((a, b) => a + b, 0);
    document.getElementById('totalQuestions').textContent = labels.reduce((a, l) => a + dailyData[l].count, 0);
  }

  // å®Ÿè¡Œ
  setupProgressChart();
  setupHistoryCharts();
</script>
</body>
</html>